import{u as g,z as b,l as x}from"./css-color-mix-Bc6Os1iC.js";import{S as N,i as v,p as _,s as w,a as k}from"./index-nJykmiXK.js";const S=g(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason}),u=s=>Symbol.iterator in s?s:{[Symbol.iterator](){return s}},m=s=>t=>C(t,s),C=(s,t)=>{const e=Set.prototype[s];if(typeof e=="function")return g(e);const n=x(t);return Object.defineProperty(Set.prototype,s,{value:n,writable:!0,enumerable:!1,configurable:!0}),t};m((s,t)=>{p(t);const e=new Set(s);for(const n of u(t.keys()))e.add(n);return e})("union");const T=m((s,t)=>{p(t);let e,n;s.size<=t.size?(e=s,n=t):(e=t.keys(),n=s);const r=new Set;for(const a of u(e))n.has(a)&&r.add(a);return r})("intersection");m((s,t)=>{p(t);const e=new Set(s);if(s.size<=t.size)for(const n of s)t.has(n)&&e.delete(n);else for(const n of u(t.keys()))e.has(n)&&e.delete(n);return e})("difference");m((s,t)=>{p(t);const e=new Set(s);for(const n of u(t.keys()))s.has(n)?e.delete(n):e.add(n);return e})("symmetricDifference");m((s,t)=>{p(t);for(const e of s)if(!t.has(e))return!1;return!0})("isSubsetOf");m((s,t)=>{p(t);for(const e of u(t.keys()))if(!s.has(e))return!1;return!0})("isSupersetOf");m((s,t)=>{if(p(t),s.size<=t.size){for(const e of s)if(t.has(e))return!1}else for(const e of u(t.keys()))if(s.has(e))return!1;return!0})("isDisjointFrom");function p(s){if(!z(s))throw new TypeError;const t=s.size,e=Number(t);if(Number.isNaN(e))throw new TypeError;if(typeof s.has!="function")throw new TypeError;if(typeof s.keys!="function")throw new TypeError}function z(s){if(s===null)return!1;const t=typeof s;return t==="object"||t==="function"}class L{finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(t,e,n,r){this.finished=t,this.ready=e,this.updateCallbackDone=n,this.__skipTransitionCallback=r}}class M extends N{getSelector(t,e){return"."+super.getSelector(t,e).replace(/[:(*)]/g,n=>`\\${n}`)}isSharedElementAnimation(t){const{effect:e}=t;if(e instanceof KeyframeEffect&&e.target&&v(e.target.classList,n=>n.startsWith(this.selectorPrefix)))return t}async startTransition(t,e,n){const r=new Map,a=new Map;new Set(r.keys()).intersection(a),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(n,"first",r);const i=_(),o=_(),c=_(),l=new AbortController;l.signal.addEventListener("abort",()=>{const f=l.signal.reason;c.reject(f),o.reject(f),i.reject(f)});const d=new L(i.promise,o.promise,c.promise,()=>{l.abort("skip")});try{(async()=>{try{await e.last?.(),S(l.signal),this.__captureLifecycleSharedElementsStyle(n,"last",a),c.resolve();const f=this.__buildSharedElementAnimations(r,a);l.signal.addEventListener("abort",()=>{f.forEach(y=>{y.cancel()})}),o.resolve(),Promise.all(f.map(y=>y.finished)).then(()=>i.resolve())}catch(f){l.abort(f)}})(),await e?.start?.(d),S(l.signal),await d.finished,S(l.signal),await e.finish?.(d),S(l.signal),this.__captureLifecycleSharedElementsStyle(n,"finish",a)}catch(f){l.abort(f)}}__captureLifecycleSharedElementsStyle(t,e,n=new Map){const r=this.__getPagesContext("last",t),{dest:a,from:i}=r;if(a==null||i==null)return n;const o=i.navEntryNode,c=a.navEntryNode;if(e==="finish"){w.delete(c),w.delete(o);return}w.set(c,e),w.set(o,e);const l={selector:"[sharedname]"},d=new Map(k.queryAllWithConfig(o,l).map(h=>[h.name,h])),f=new Map(k.queryAllWithConfig(c,l).map(h=>[h.name,h])),y=T(new Set(d.keys()),f),$=e==="first"?d:f;for(const h of y){const{element:E}=$.get(h),A=E.getSharedStyle();n.set(h,{element:E,...A})}for(const h of[o,c])h.sharedName&&n.set(h.sharedName,{element:h,...h.getSharedStyle()});return n}__doAni(t,e,n,r){const a=e.element;if(/appn-nav/i.test(e.element.tagName))debugger;const i={transformOrigin:"top left",...e.baseStyle},o=[{...i,...b(t).with("old",()=>({translate:`${n.left}px ${n.top}px`,scale:"1 1",opacity:1})).with("new",()=>({translate:`${r.left}px ${r.top}px`,scale:`${r.width/n.width} ${r.height/n.height}`,opacity:0})).with("shared",()=>({translate:`${n.left}px ${n.top}px`,scale:`${n.width/r.width} ${n.height/r.height}`})).exhaustive(),offset:0},{...i,...b(t).with("old",()=>({translate:`${r.left}px ${r.top}px`,scale:`${r.width/n.width} ${r.height/n.height}`,opacity:0})).with("new",()=>({translate:`${n.left}px ${n.top}px`,scale:"1 1",opacity:1})).with("shared",()=>({translate:`${r.left}px ${r.top}px`,scale:`${n.width/r.width} ${n.height/r.height}`})).exhaustive(),offset:1}];return console.log("QAQ keyframes",t,e.element,o),a.createSharedAnimation(o,{duration:this.animationDuration,easing:this.animationEasing})}__buildSharedElementAnimations(t,e){const n=[];for(const[r,a]of t){if(!e.has(r))continue;const i=e.get(r);if(a.element===i.element){const o=this.__doAni("shared",a,a.fromBounding,i.toBounding(a.fromBounding));n.push(o)}else{const o=this.__doAni("old",a,a.fromBounding,i.toBounding(a.fromBounding)),c=this.__doAni("new",i,i.fromBounding,a.toBounding(i.fromBounding));n.push(o,c)}}return n}}const O=new M;export{M as SharedElementPonyfill,O as sharedElementPonyfill};
