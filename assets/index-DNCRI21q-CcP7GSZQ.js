import{u as E,l as k}from"./css-color-mix-Bc6Os1iC.js";import{S as A,i as C,p as w,s as y,a as b}from"./index-Bz2nVrdq.js";const S=E(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason}),u=s=>Symbol.iterator in s?s:{[Symbol.iterator](){return s}},d=s=>t=>x(t,s),x=(s,t)=>{const e=Set.prototype[s];if(typeof e=="function")return E(e);const n=k(t);return Object.defineProperty(Set.prototype,s,{value:n,writable:!0,enumerable:!1,configurable:!0}),t};d((s,t)=>{p(t);const e=new Set(s);for(const n of u(t.keys()))e.add(n);return e})("union");const T=d((s,t)=>{p(t);let e,n;s.size<=t.size?(e=s,n=t):(e=t.keys(),n=s);const i=new Set;for(const r of u(e))n.has(r)&&i.add(r);return i})("intersection");d((s,t)=>{p(t);const e=new Set(s);if(s.size<=t.size)for(const n of s)t.has(n)&&e.delete(n);else for(const n of u(t.keys()))e.has(n)&&e.delete(n);return e})("difference");d((s,t)=>{p(t);const e=new Set(s);for(const n of u(t.keys()))s.has(n)?e.delete(n):e.add(n);return e})("symmetricDifference");d((s,t)=>{p(t);for(const e of s)if(!t.has(e))return!1;return!0})("isSubsetOf");d((s,t)=>{p(t);for(const e of u(t.keys()))if(!s.has(e))return!1;return!0})("isSupersetOf");d((s,t)=>{if(p(t),s.size<=t.size){for(const e of s)if(t.has(e))return!1}else for(const e of u(t.keys()))if(s.has(e))return!1;return!0})("isDisjointFrom");function p(s){if(!v(s))throw new TypeError;const t=s.size,e=Number(t);if(Number.isNaN(e))throw new TypeError;if(typeof s.has!="function")throw new TypeError;if(typeof s.keys!="function")throw new TypeError}function v(s){if(s===null)return!1;const t=typeof s;return t==="object"||t==="function"}class z{finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(t,e,n,i){this.finished=t,this.ready=e,this.updateCallbackDone=n,this.__skipTransitionCallback=i}}class L extends A{getSelector(t,e){return"."+super.getSelector(t,e).replace(/[:(*)]/g,n=>`\\${n}`)}isSharedElementAnimation(t){const{effect:e}=t;if(e instanceof KeyframeEffect&&e.target&&C(e.target.classList,n=>n.startsWith(this.selectorPrefix)))return t}async startTransition(t,e,n){const i=new Map,r=new Map;new Set(i.keys()).intersection(r),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(n,"first",i);const a=w(),f=w(),h=w(),o=new AbortController;o.signal.addEventListener("abort",()=>{const l=o.signal.reason;h.reject(l),f.reject(l),a.reject(l)});const m=new z(a.promise,f.promise,h.promise,()=>{o.abort("skip")});try{(async()=>{try{await e.last?.(),S(o.signal),this.__captureLifecycleSharedElementsStyle(n,"last",r),h.resolve();const l=this.__buildSharedElementAnimations(i,r);o.signal.addEventListener("abort",()=>{l.forEach(c=>{c.cancel()})}),f.resolve(),Promise.all(l.map(c=>c.finished)).then(()=>a.resolve())}catch(l){o.abort(l)}})(),await e?.start?.(m),S(o.signal),await m.finished,S(o.signal),await e.finish?.(m),S(o.signal),this.__captureLifecycleSharedElementsStyle(n,"finish",r)}catch(l){o.abort(l)}}constructor(){super();const t=String.raw;this.css.addRules(t``)}__captureLifecycleSharedElementsStyle(t,e,n=new Map){const i=this.__getPagesContext("last",t),{dest:r,from:a}=i;if(r==null||a==null)return n;if(e==="finish"){y.delete(r.node),y.delete(a.node);return}y.set(r.node,e),y.set(a.node,e);const f={selector:"appn-shared-contents"},h=new Map(b.queryAllWithConfig(a.node,f).map(c=>[c.name,c])),o=new Map(b.queryAllWithConfig(r.node,f).map(c=>[c.name,c])),m=T(new Set(h.keys()),o),l=e==="first"?h:o;for(const c of m){const{element:_}=l.get(c),g=_.getSharedStyle();n.set(c,{element:_,...g})}return n}__doAni(t,e,n){const i=t.element,r={margin:0,overflow:"hidden",borderWidth:0,outline:"1px solid #0003",transformOrigin:"top left",inset:0};return i.createSharedAnimation([{...r,offset:0,top:e.top+"px",left:e.left+"px",...t.boudingRect===e?{width:e.width+"px",height:e.height+"px",scale:"1 1",opacity:1}:{width:n.width+"px",height:n.height+"px",scale:`${e.width/n.width} ${e.height/n.height}`,opacity:0}},{...r,offset:1,top:n.top+"px",left:n.left+"px",...t.boudingRect===e?{scale:`${n.width/e.width} ${n.height/e.height}`,opacity:0}:{scale:"1 1",opacity:1}}],{duration:this.pageAnimationDuration})}__buildSharedElementAnimations(t,e){const n=[];for(const[i,r]of t){if(!e.has(i))continue;const a=e.get(i);console.log(i,r,a);const f=this.__doAni(r,r.boudingRect,a.boudingRect),h=this.__doAni(a,r.boudingRect,a.boudingRect);n.push(f,h)}return n}}const N=new L;export{L as SharedElementPonyfill,N as sharedElementPonyfill};
