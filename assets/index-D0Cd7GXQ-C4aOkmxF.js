import{u as b,z as g,l as N}from"./css-color-mix-BdxgKm7p.js";import{S as v,i as T,p as S,s as w,a as E}from"./index-DgYdCWti.js";const _=b(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason}),y=n=>Symbol.iterator in n?n:{[Symbol.iterator](){return n}},u=n=>t=>z(t,n),z=(n,t)=>{const e=Set.prototype[n];if(typeof e=="function")return b(e);const r=N(t);return Object.defineProperty(Set.prototype,n,{value:r,writable:!0,enumerable:!1,configurable:!0}),t};u((n,t)=>{m(t);const e=new Set(n);for(const r of y(t.keys()))e.add(r);return e})("union");const $=u((n,t)=>{m(t);let e,r;n.size<=t.size?(e=n,r=t):(e=t.keys(),r=n);const o=new Set;for(const s of y(e))r.has(s)&&o.add(s);return o})("intersection");u((n,t)=>{m(t);const e=new Set(n);if(n.size<=t.size)for(const r of n)t.has(r)&&e.delete(r);else for(const r of y(t.keys()))e.has(r)&&e.delete(r);return e})("difference");u((n,t)=>{m(t);const e=new Set(n);for(const r of y(t.keys()))n.has(r)?e.delete(r):e.add(r);return e})("symmetricDifference");u((n,t)=>{m(t);for(const e of n)if(!t.has(e))return!1;return!0})("isSubsetOf");u((n,t)=>{m(t);for(const e of y(t.keys()))if(!n.has(e))return!1;return!0})("isSupersetOf");u((n,t)=>{if(m(t),n.size<=t.size){for(const e of n)if(t.has(e))return!1}else for(const e of y(t.keys()))if(n.has(e))return!1;return!0})("isDisjointFrom");function m(n){if(!L(n))throw new TypeError;const t=n.size,e=Number(t);if(Number.isNaN(e))throw new TypeError;if(typeof n.has!="function")throw new TypeError;if(typeof n.keys!="function")throw new TypeError}function L(n){if(n===null)return!1;const t=typeof n;return t==="object"||t==="function"}class M{finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(t,e,r,o){this.finished=t,this.ready=e,this.updateCallbackDone=r,this.__skipTransitionCallback=o}}class P extends v{getSelector(t,e){return"."+super.getSelector(t,e).replace(/[:(*)]/g,r=>`\\${r}`)}isSharedElementAnimation(t){const{effect:e}=t;if(e instanceof KeyframeEffect&&e.target&&T(e.target.classList,r=>r.startsWith(this.selectorPrefix)))return t}async startTransition(t,e,r){const o=new Map,s=new Map;new Set(o.keys()).intersection(s),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(r,"first",o);const i=S(),l=S(),c=S(),a=new AbortController;a.signal.addEventListener("abort",()=>{const f=a.signal.reason;c.reject(f),l.reject(f),i.reject(f)});const d=new M(i.promise,l.promise,c.promise,()=>{a.abort("skip")});try{(async()=>{try{await e.last?.(),_(a.signal),this.__captureLifecycleSharedElementsStyle(r,"last",s),c.resolve();const f=this.__buildSharedElementAnimations(o,s);a.signal.addEventListener("abort",()=>{f.forEach(p=>{p.cancel()})}),l.resolve(),Promise.all(f.map(p=>p.finished)).then(()=>i.resolve())}catch(f){a.abort(f)}})(),await e?.start?.(d),_(a.signal),await d.finished,_(a.signal),await e.finish?.(d),_(a.signal),this.__captureLifecycleSharedElementsStyle(r,"finish",s)}catch(f){a.abort(f)}}__captureLifecycleSharedElementsStyle(t,e,r=new Map){const o=this.__getPagesContext("last",t),{dest:s,from:i}=o;if(s==null||i==null)return r;const l=i.navEntryNode,c=s.navEntryNode;if(e==="finish"){w.delete(c),w.delete(l);return}w.set(c,e),w.set(l,e);const a={selector:"[sharedname]"},d=new Map(E.queryAllWithConfig(l,a).map(h=>[h.name,h])),f=new Map(E.queryAllWithConfig(c,a).map(h=>[h.name,h])),p=$(new Set(d.keys()),f),k=e==="first"?d:f;for(const h of p){const{element:A}=k.get(h),C=A.sharedController.getSharedSnap();r.set(h,C)}for(const h of[l,c])h.sharedName&&r.set(h.sharedName,h.sharedController.getSharedSnap());return r}__doAni(t,e,r,o){const s=r.fromBounding,i=o.fromBounding,l=e.element,c={transformOrigin:"top left",...e.baseStyle},a=[{...c,translate:e.toTranslate(r,t),...g(t).with("old",()=>({scale:"1 1",opacity:1})).with("new",()=>({scale:`${s.width/i.width} ${s.height/i.height}`,opacity:0})).with("shared",()=>({scale:`${s.width/i.width} ${s.height/i.height}`})).exhaustive(),offset:0},{...c,translate:e.toTranslate(o,t),...g(t).with("old",()=>({scale:`${i.width/s.width} ${i.height/s.height}`,opacity:0})).with("new",()=>({scale:"1 1",opacity:1})).with("shared",()=>({scale:`${s.width/i.width} ${s.height/i.height}`})).exhaustive(),offset:1}];return console.log("QAQ keyframes",t,e.element,a),l.sharedController.createSharedAnimation(a,{duration:this.animationDuration,easing:this.animationEasing})}__buildSharedElementAnimations(t,e){const r=[];for(const[o,s]of t){if(!e.has(o))continue;const i=e.get(o);if(s.element===i.element){const l=this.__doAni("shared",s,s,i);r.push(l)}else{const l=this.__doAni("old",s,s,i),c=this.__doAni("new",i,s,i);r.push(l,c)}}return r}}const x=new P;export{P as SharedElementPonyfill,x as sharedElementPonyfill};
