import{z as _}from"./index-lqWRYX0p-DE3jboEo.js";import{u as b}from"./func-zDoQbW14-Bezqm8jT.js";import{p as u}from"./promise-with-resolvers.polyfill-DmWLZHIp-BuQ_xy-h.js";import{S as A,a as f,s as g,b as k}from"./set-D7C9SjWk-lX7cOXGY.js";import{b as v}from"./iterable-egH69lT2-CF8SKj3F.js";const p=b(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason});class C{finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(r,e,n,o){this.finished=r,this.ready=e,this.updateCallbackDone=n,this.__skipTransitionCallback=o}}class N extends A{getSelector(r,e){return"."+super.getSelector(r,e).replace(/[:(*)]/g,n=>`\\${n}`)}isSharedElementAnimation(r){const{effect:e}=r;if(e instanceof KeyframeEffect&&e.target&&v(e.target.classList,n=>n.startsWith(this.selectorPrefix)))return r}async startTransition(r,e,n){const o=new Map,t=new Map;new Set(o.keys()).intersection(t),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(n,"first",o);const s=u(),i=u(),l=u(),a=new AbortController;a.signal.addEventListener("abort",()=>{const h=a.signal.reason;l.reject(h),i.reject(h),s.reject(h)});const d=new C(s.promise,i.promise,l.promise,()=>{a.abort("skip")});try{(async()=>{try{await e.last?.(),p(a.signal),this.__captureLifecycleSharedElementsStyle(n,"last",t),l.resolve();const h=this.__buildSharedElementAnimations(o,t);a.signal.addEventListener("abort",()=>{h.forEach(m=>{m.cancel()})}),i.resolve(),Promise.all(h.map(m=>m.finished)).then(()=>s.resolve())}catch(h){a.abort(h)}})(),await e?.start?.(d),p(a.signal),await d.finished,p(a.signal),await e.finish?.(d),p(a.signal),this.__captureLifecycleSharedElementsStyle(n,"finish",t)}catch(h){a.abort(h)}}__captureLifecycleSharedElementsStyle(r,e,n=new Map){const o=this.__getPagesContext("last",r),{dest:t,from:s}=o;if(t==null||s==null)return n;const i=s.navEntryNode,l=t.navEntryNode;if(e==="finish"){f.delete(l),f.delete(i);return}f.set(l,e),f.set(i,e);const a={selector:"[sharedname]"},d=new Map(g.queryAllWithConfig(i,a).map(c=>[c.name,c])),h=new Map(g.queryAllWithConfig(l,a).map(c=>[c.name,c])),m=k(new Set(d.keys()),h),y=e==="first"?d:h;for(const c of m){const{element:E}=y.get(c),S=E.sharedController.getSharedSnap();n.set(c,S)}for(const c of[i,l])c.sharedName&&n.set(c.sharedName,c.sharedController.getSharedSnap());return n}__doAni(r,e,n,o){const t=n.fromBounding,s=o.fromBounding,i=e.element,l={transformOrigin:"top left",...e.baseStyle},a=[{...l,translate:e.toTranslate(n,r),..._(r).with("old",()=>({scale:"1 1",opacity:1})).with("new",()=>({scale:`${t.width/s.width} ${t.height/s.height}`,opacity:0})).with("shared",()=>({scale:`${t.width/s.width} ${t.height/s.height}`})).exhaustive(),offset:0},{...l,translate:e.toTranslate(o,r),..._(r).with("old",()=>({scale:`${s.width/t.width} ${s.height/t.height}`,opacity:0})).with("new",()=>({scale:"1 1",opacity:1})).with("shared",()=>({scale:`${t.width/s.width} ${t.height/s.height}`})).exhaustive(),offset:1}];return console.log("QAQ keyframes",r,e.element,a),i.sharedController.createSharedAnimation(a,{duration:this.animationDuration,easing:this.animationEasing})}__buildSharedElementAnimations(r,e){const n=[];for(const[o,t]of r){if(!e.has(o))continue;const s=e.get(o);if(t.element===s.element){const i=this.__doAni("shared",t,t,s);n.push(i)}else{const i=this.__doAni("old",t,t,s),l=this.__doAni("new",s,t,s);n.push(i,l)}}return n}}const x=new N;export{N as SharedElementPonyfill,x as sharedElementPonyfill};
