import{u as g,l as N}from"./css-color-mix-Bc6Os1iC.js";import{S as v,i as C,p as w,s as S,a as E}from"./index-DcbVFZTo.js";const _=g(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason}),p=s=>Symbol.iterator in s?s:{[Symbol.iterator](){return s}},d=s=>t=>T(t,s),T=(s,t)=>{const e=Set.prototype[s];if(typeof e=="function")return g(e);const n=N(t);return Object.defineProperty(Set.prototype,s,{value:n,writable:!0,enumerable:!1,configurable:!0}),t};d((s,t)=>{m(t);const e=new Set(s);for(const n of p(t.keys()))e.add(n);return e})("union");const x=d((s,t)=>{m(t);let e,n;s.size<=t.size?(e=s,n=t):(e=t.keys(),n=s);const r=new Set;for(const i of p(e))n.has(i)&&r.add(i);return r})("intersection");d((s,t)=>{m(t);const e=new Set(s);if(s.size<=t.size)for(const n of s)t.has(n)&&e.delete(n);else for(const n of p(t.keys()))e.has(n)&&e.delete(n);return e})("difference");d((s,t)=>{m(t);const e=new Set(s);for(const n of p(t.keys()))s.has(n)?e.delete(n):e.add(n);return e})("symmetricDifference");d((s,t)=>{m(t);for(const e of s)if(!t.has(e))return!1;return!0})("isSubsetOf");d((s,t)=>{m(t);for(const e of p(t.keys()))if(!s.has(e))return!1;return!0})("isSupersetOf");d((s,t)=>{if(m(t),s.size<=t.size){for(const e of s)if(t.has(e))return!1}else for(const e of p(t.keys()))if(s.has(e))return!1;return!0})("isDisjointFrom");function m(s){if(!z(s))throw new TypeError;const t=s.size,e=Number(t);if(Number.isNaN(e))throw new TypeError;if(typeof s.has!="function")throw new TypeError;if(typeof s.keys!="function")throw new TypeError}function z(s){if(s===null)return!1;const t=typeof s;return t==="object"||t==="function"}class ${finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(t,e,n,r){this.finished=t,this.ready=e,this.updateCallbackDone=n,this.__skipTransitionCallback=r}}class L extends v{getSelector(t,e){return"."+super.getSelector(t,e).replace(/[:(*)]/g,n=>`\\${n}`)}isSharedElementAnimation(t){const{effect:e}=t;if(e instanceof KeyframeEffect&&e.target&&C(e.target.classList,n=>n.startsWith(this.selectorPrefix)))return t}async startTransition(t,e,n){const r=new Map,i=new Map;new Set(r.keys()).intersection(i),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(n,"first",r);const a=w(),o=w(),h=w(),l=new AbortController;l.signal.addEventListener("abort",()=>{const c=l.signal.reason;h.reject(c),o.reject(c),a.reject(c)});const u=new $(a.promise,o.promise,h.promise,()=>{l.abort("skip")});try{(async()=>{try{await e.last?.(),_(l.signal),this.__captureLifecycleSharedElementsStyle(n,"last",i),h.resolve();const c=this.__buildSharedElementAnimations(r,i);l.signal.addEventListener("abort",()=>{c.forEach(y=>{y.cancel()})}),o.resolve(),Promise.all(c.map(y=>y.finished)).then(()=>a.resolve())}catch(c){l.abort(c)}})(),await e?.start?.(u),_(l.signal),await u.finished,_(l.signal),await e.finish?.(u),_(l.signal),this.__captureLifecycleSharedElementsStyle(n,"finish",i)}catch(c){l.abort(c)}}__captureLifecycleSharedElementsStyle(t,e,n=new Map){const r=this.__getPagesContext("last",t),{dest:i,from:a}=r;if(i==null||a==null)return n;const o=a.navEntryNode,h=i.navEntryNode;if(e==="finish"){S.delete(h),S.delete(o);return}S.set(h,e),S.set(o,e);const l={selector:"[sharedname]"},u=new Map(E.queryAllWithConfig(o,l).map(f=>[f.name,f])),c=new Map(E.queryAllWithConfig(h,l).map(f=>[f.name,f])),y=x(new Set(u.keys()),c),k=e==="first"?u:c;for(const f of y){const{element:b}=k.get(f),A=b.getSharedStyle();n.set(f,{element:b,...A})}for(const f of[o,h])f.sharedName&&n.set(f.sharedName,{element:f,...f.getSharedStyle()});return n}__doAni(t,e,n,r){const i=e.element,a={transformOrigin:"top left",...e.baseStyle},o=[{...a,translate:`${n.left}px ${n.top}px`,offset:0,...e.boudingRect===n?{width:n.width+"px",height:n.height+"px",scale:"1 1",opacity:1}:{width:r.width+"px",height:r.height+"px",scale:`${n.width/r.width} ${n.height/r.height}`,opacity:t==="shared"?1:0}},{...a,offset:1,translate:`${r.left}px ${r.top}px`,...e.boudingRect===n?{scale:`${r.width/n.width} ${r.height/n.height}`,opacity:t==="shared"?1:0}:{scale:"1 1",opacity:1}}];return console.log("QAQ keyframes",o),i.createSharedAnimation(o,{duration:this.animationDuration,easing:this.animationEasing})}__buildSharedElementAnimations(t,e){const n=[];for(const[r,i]of t){if(!e.has(r))continue;const a=e.get(r);if(console.log(r,i.element===a.element,i,a),i.element===a.element){const o=this.__doAni("shared",i,i.boudingRect,a.boudingRect);n.push(o)}else{const o=this.__doAni("old",i,i.boudingRect,a.boudingRect),h=this.__doAni("new",a,i.boudingRect,a.boudingRect);n.push(o,h)}}return n}}const D=new L;export{L as SharedElementPonyfill,D as sharedElementPonyfill};
