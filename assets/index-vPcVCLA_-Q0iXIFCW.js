import{u as b,z as _}from"./css-color-mix-CY0KkXf5.js";import{S as A,i as k,p as u,s as f,a as g,b as v}from"./index-CB1Dj6tX.js";const p=b(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason});class C{finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(a,e,n,o){this.finished=a,this.ready=e,this.updateCallbackDone=n,this.__skipTransitionCallback=o}}class N extends A{getSelector(a,e){return"."+super.getSelector(a,e).replace(/[:(*)]/g,n=>`\\${n}`)}isSharedElementAnimation(a){const{effect:e}=a;if(e instanceof KeyframeEffect&&e.target&&k(e.target.classList,n=>n.startsWith(this.selectorPrefix)))return a}async startTransition(a,e,n){const o=new Map,t=new Map;new Set(o.keys()).intersection(t),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(n,"first",o);const s=u(),i=u(),l=u(),r=new AbortController;r.signal.addEventListener("abort",()=>{const h=r.signal.reason;l.reject(h),i.reject(h),s.reject(h)});const d=new C(s.promise,i.promise,l.promise,()=>{r.abort("skip")});try{(async()=>{try{await e.last?.(),p(r.signal),this.__captureLifecycleSharedElementsStyle(n,"last",t),l.resolve();const h=this.__buildSharedElementAnimations(o,t);r.signal.addEventListener("abort",()=>{h.forEach(m=>{m.cancel()})}),i.resolve(),Promise.all(h.map(m=>m.finished)).then(()=>s.resolve())}catch(h){r.abort(h)}})(),await e?.start?.(d),p(r.signal),await d.finished,p(r.signal),await e.finish?.(d),p(r.signal),this.__captureLifecycleSharedElementsStyle(n,"finish",t)}catch(h){r.abort(h)}}__captureLifecycleSharedElementsStyle(a,e,n=new Map){const o=this.__getPagesContext("last",a),{dest:t,from:s}=o;if(t==null||s==null)return n;const i=s.navEntryNode,l=t.navEntryNode;if(e==="finish"){f.delete(l),f.delete(i);return}f.set(l,e),f.set(i,e);const r={selector:"[sharedname]"},d=new Map(g.queryAllWithConfig(i,r).map(c=>[c.name,c])),h=new Map(g.queryAllWithConfig(l,r).map(c=>[c.name,c])),m=v(new Set(d.keys()),h),y=e==="first"?d:h;for(const c of m){const{element:E}=y.get(c),S=E.sharedController.getSharedSnap();n.set(c,S)}for(const c of[i,l])c.sharedName&&n.set(c.sharedName,c.sharedController.getSharedSnap());return n}__doAni(a,e,n,o){const t=n.fromBounding,s=o.fromBounding,i=e.element,l={transformOrigin:"top left",...e.baseStyle},r=[{...l,translate:e.toTranslate(n,a),..._(a).with("old",()=>({scale:"1 1",opacity:1})).with("new",()=>({scale:`${t.width/s.width} ${t.height/s.height}`,opacity:0})).with("shared",()=>({scale:`${t.width/s.width} ${t.height/s.height}`})).exhaustive(),offset:0},{...l,translate:e.toTranslate(o,a),..._(a).with("old",()=>({scale:`${s.width/t.width} ${s.height/t.height}`,opacity:0})).with("new",()=>({scale:"1 1",opacity:1})).with("shared",()=>({scale:`${t.width/s.width} ${t.height/s.height}`})).exhaustive(),offset:1}];return console.log("QAQ keyframes",a,e.element,r),i.sharedController.createSharedAnimation(r,{duration:this.animationDuration,easing:this.animationEasing})}__buildSharedElementAnimations(a,e){const n=[];for(const[o,t]of a){if(!e.has(o))continue;const s=e.get(o);if(t.element===s.element){const i=this.__doAni("shared",t,t,s);n.push(i)}else{const i=this.__doAni("old",t,t,s),l=this.__doAni("new",s,t,s);n.push(i,l)}}return n}}const L=new N;export{N as SharedElementPonyfill,L as sharedElementPonyfill};
