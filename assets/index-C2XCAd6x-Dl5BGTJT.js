import{u as b,z as S,l as v}from"./css-color-mix-Bc6Os1iC.js";import{S as T,i as C,p as g,s as w,a as E}from"./index-BfTluGWP.js";const _=b(AbortSignal.prototype.throwIfAborted??=function(){if(this.aborted)throw this.reason}),p=n=>Symbol.iterator in n?n:{[Symbol.iterator](){return n}},d=n=>t=>z(t,n),z=(n,t)=>{const e=Set.prototype[n];if(typeof e=="function")return b(e);const r=v(t);return Object.defineProperty(Set.prototype,n,{value:r,writable:!0,enumerable:!1,configurable:!0}),t};d((n,t)=>{m(t);const e=new Set(n);for(const r of p(t.keys()))e.add(r);return e})("union");const $=d((n,t)=>{m(t);let e,r;n.size<=t.size?(e=n,r=t):(e=t.keys(),r=n);const a=new Set;for(const s of p(e))r.has(s)&&a.add(s);return a})("intersection");d((n,t)=>{m(t);const e=new Set(n);if(n.size<=t.size)for(const r of n)t.has(r)&&e.delete(r);else for(const r of p(t.keys()))e.has(r)&&e.delete(r);return e})("difference");d((n,t)=>{m(t);const e=new Set(n);for(const r of p(t.keys()))n.has(r)?e.delete(r):e.add(r);return e})("symmetricDifference");d((n,t)=>{m(t);for(const e of n)if(!t.has(e))return!1;return!0})("isSubsetOf");d((n,t)=>{m(t);for(const e of p(t.keys()))if(!n.has(e))return!1;return!0})("isSupersetOf");d((n,t)=>{if(m(t),n.size<=t.size){for(const e of n)if(t.has(e))return!1}else for(const e of p(t.keys()))if(n.has(e))return!1;return!0})("isDisjointFrom");function m(n){if(!L(n))throw new TypeError;const t=n.size,e=Number(t);if(Number.isNaN(e))throw new TypeError;if(typeof n.has!="function")throw new TypeError;if(typeof n.keys!="function")throw new TypeError}function L(n){if(n===null)return!1;const t=typeof n;return t==="object"||t==="function"}class M{finished;ready;updateCallbackDone;__skipTransitionCallback;__skipped=!1;skipTransition(){this.__skipped||(this.__skipped=!0,this.__skipTransitionCallback())}constructor(t,e,r,a){this.finished=t,this.ready=e,this.updateCallbackDone=r,this.__skipTransitionCallback=a}}class P extends T{getSelector(t,e){return"."+super.getSelector(t,e).replace(/[:(*)]/g,r=>`\\${r}`)}isSharedElementAnimation(t){const{effect:e}=t;if(e instanceof KeyframeEffect&&e.target&&C(e.target.classList,r=>r.startsWith(this.selectorPrefix)))return t}async startTransition(t,e,r){const a=new Map,s=new Map;new Set(a.keys()).intersection(s),await e?.first?.(),this.__captureLifecycleSharedElementsStyle(r,"first",a);const i=g(),l=g(),c=g(),o=new AbortController;o.signal.addEventListener("abort",()=>{const f=o.signal.reason;c.reject(f),l.reject(f),i.reject(f)});const u=new M(i.promise,l.promise,c.promise,()=>{o.abort("skip")});try{(async()=>{try{await e.last?.(),_(o.signal),this.__captureLifecycleSharedElementsStyle(r,"last",s),c.resolve();const f=this.__buildSharedElementAnimations(a,s);o.signal.addEventListener("abort",()=>{f.forEach(y=>{y.cancel()})}),l.resolve(),Promise.all(f.map(y=>y.finished)).then(()=>i.resolve())}catch(f){o.abort(f)}})(),await e?.start?.(u),_(o.signal),await u.finished,_(o.signal),await e.finish?.(u),_(o.signal),this.__captureLifecycleSharedElementsStyle(r,"finish",s)}catch(f){o.abort(f)}}__captureLifecycleSharedElementsStyle(t,e,r=new Map){const a=this.__getPagesContext("last",t),{dest:s,from:i}=a;if(s==null||i==null)return r;const l=i.navEntryNode,c=s.navEntryNode;if(e==="finish"){w.delete(c),w.delete(l);return}w.set(c,e),w.set(l,e);const o={selector:"[sharedname]"},u=new Map(E.queryAllWithConfig(l,o).map(h=>[h.name,h])),f=new Map(E.queryAllWithConfig(c,o).map(h=>[h.name,h])),y=$(new Set(u.keys()),f),k=e==="first"?u:f;for(const h of y){const{element:A}=k.get(h),N=A.getSnap();r.set(h,N)}for(const h of[l,c])h.sharedName&&r.set(h.sharedName,h.getSnap());return r}__doAni(t,e,r,a){const s=r.fromBounding,i=a.fromBounding,l=e.element;if(/appn-nav/i.test(e.element.tagName))debugger;const c={transformOrigin:"top left",...e.baseStyle},o=[{...c,translate:e.toTranslate(r,t),...S(t).with("old",()=>({scale:"1 1",opacity:1})).with("new",()=>({scale:`${s.width/i.width} ${s.height/i.height}`,opacity:0})).with("shared",()=>({scale:`${s.width/i.width} ${s.height/i.height}`})).exhaustive(),offset:0},{...c,translate:e.toTranslate(a,t),...S(t).with("old",()=>({scale:`${i.width/s.width} ${i.height/s.height}`,opacity:0})).with("new",()=>({scale:"1 1",opacity:1})).with("shared",()=>({scale:`${s.width/i.width} ${s.height/i.height}`})).exhaustive(),offset:1}];return console.log("QAQ keyframes",t,e.element,o),l.createSharedAnimation(o,{duration:this.animationDuration,easing:this.animationEasing})}__buildSharedElementAnimations(t,e){const r=[];for(const[a,s]of t){if(!e.has(a))continue;const i=e.get(a);if(s.element===i.element){const l=this.__doAni("shared",s,s,i);r.push(l)}else{const l=this.__doAni("old",s,s,i),c=this.__doAni("new",i,s,i);r.push(l,c)}}return r}}const x=new P;export{P as SharedElementPonyfill,x as sharedElementPonyfill};
