import{z as I,f as F,_ as q,b as k}from"./css-color-mix-CkVeYiGO.js";import{e as W}from"./my-element-DYKbo5aa.js";class z extends Event{#t;constructor(t){if(super("navigate",t),!t)throw new TypeError("init required");if(!t.destination)throw new TypeError("destination required");if(!t.signal)throw new TypeError("signal required");this.#t={canIntercept:t.canIntercept??!1,destination:t.destination,downloadRequest:t.downloadRequest||null,formData:t.formData||null,hasUAVisualTransition:!1,hashChange:t.hashChange??!1,info:t.info,signal:t.signal,userInitiated:t.userInitiated??!1,navigationType:t.navigationType??"push"}}async __runHandler(){const t=this.#n;typeof t=="function"&&await t.call(this),this.#e,this.#r}get navigationType(){return this.#t.navigationType}get canIntercept(){return this.#t.canIntercept}get canTransition(){return this.#t.canIntercept}get userInitiated(){return this.#t.userInitiated}get hashChange(){return this.#t.hashChange}get hasUAVisualTransition(){return this.#t.hasUAVisualTransition}get destination(){return this.#t.destination}get signal(){return this.#t.signal}get formData(){return this.#t.formData}get downloadRequest(){return this.#t.downloadRequest}get info(){return this.#t.info}#n;#e;#r;intercept(t){t&&(this.#n=t.handler,this.#e=t.focusReset,this.#r=t.scroll)}scroll(){}}Promise.withResolvers||(Promise.withResolvers=function(){let e,t;return{promise:new this((r,s)=>{e=r,t=s}),resolve:e,reject:t}});const j=Promise.withResolvers.bind(Promise);class H extends Event{__init;constructor(t){super("currententrychange",t),this.__init=t}get navigationType(){return this.__init.navigationType??null}get from(){return this.__init.from}}class G{__init;get id(){return this.__init.id}get index(){return this.__init.index}get key(){return this.__init.key}get sameDocument(){return!0}get url(){return this.__init.url}getState(){return this.__init.state}constructor(t){this.__init=t}}let w=(()=>{let e=EventTarget,t,n=[],r=[];return class extends e{static{const i=typeof Symbol=="function"&&Symbol.metadata?Object.create(e[Symbol.metadata]??null):void 0;t=[W()],q(this,null,t,{kind:"accessor",name:"ondispose",static:!1,private:!1,access:{has:o=>"ondispose"in o,get:o=>o.ondispose,set:(o,a)=>{o.ondispose=a}},metadata:i},n,r),i&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:i})}__init;get id(){return this.__init.id}get index(){return this.__init.index}get key(){return this.__init.key}get sameDocument(){return!0}get url(){return this.__init.url}getState(){return this.__init.state}__getInit(){return this.__init}__setState(i){this.__init.state=i}#t=k(this,n,void 0);get ondispose(){return this.#t}set ondispose(i){this.#t=i}constructor(i){super(),k(this,r),this.__init=i}}})();class ${__init;constructor(t){this.__init=t}get navigationType(){return this.__init.navigationType}get from(){return this.__init.from}get finished(){return this.__init.finished}}const x=(e,t)=>t.some(n=>e instanceof n);let L,R;function J(){return L||(L=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Q(){return R||(R=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const S=new WeakMap,b=new WeakMap,p=new WeakMap;function X(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{n(f(e.result)),s()},o=()=>{r(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",o)});return p.set(t,e),t}function Y(e){if(S.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{n(),s()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});S.set(e,t)}let T={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return S.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function K(e){T=e(T)}function Z(e){return Q().includes(e)?function(...t){return e.apply(B(this),t),f(this.request)}:function(...t){return f(e.apply(B(this),t))}}function tt(e){return typeof e=="function"?Z(e):(e instanceof IDBTransaction&&Y(e),x(e,J())?new Proxy(e,T):e)}function f(e){if(e instanceof IDBRequest)return X(e);if(b.has(e))return b.get(e);const t=tt(e);return t!==e&&(b.set(e,t),p.set(t,e)),t}const B=e=>p.get(e);function et(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(e,t),a=f(o);return r&&o.addEventListener("upgradeneeded",c=>{r(f(o.result),c.oldVersion,c.newVersion,f(o.transaction),c)}),n&&o.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),a}const nt=["get","getKey","getAll","getAllKeys","count"],rt=["put","add","delete","clear"],v=new Map;function U(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(v.get(t))return v.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=rt.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||nt.includes(n)))return;const i=async function(o,...a){const c=this.transaction(o,s?"readwrite":"readonly");let d=c.store;return r&&(d=d.index(a.shift())),(await Promise.all([d[n](...a),s&&c.done]))[0]};return v.set(t,i),i}K(e=>({...e,get:(t,n,r)=>U(t,n)||e.get(t,n,r),has:(t,n)=>!!U(t,n)||e.has(t,n)}));const st=["continue","continuePrimaryKey","advance"],O={},C=new WeakMap,V=new WeakMap,it={get(e,t){if(!st.includes(t))return e[t];let n=O[t];return n||(n=O[t]=function(...r){C.set(this,V.get(this)[t](...r))}),n}};async function*ot(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,it);for(V.set(n,t),p.set(n,B(t));t;)yield n,t=await(C.get(n)||t.continue()),C.delete(n)}function A(e,t){return t===Symbol.asyncIterator&&x(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&x(e,[IDBIndex,IDBObjectStore])}K(e=>({...e,get(t,n,r){return A(t,n)?ot:e.get(t,n,r)},has(t,n){return A(t,n)||e.has(t,n)}}));const E=await et("appn-navigation",1,{upgrade(e){e.createObjectStore("entries",{keyPath:"key"}).createIndex("sessionKey","sessionKey")}}),_="--appn-navigation-reload--";sessionStorage.getItem(_)==_;const M=history.state?.sessionKey??crypto.randomUUID(),at=async()=>{const e=E.transaction("entries"),n=await e.objectStore("entries").index("sessionKey").getAll(M);return e.commit(),n.sort((r,s)=>r.index-s.index)},ct=()=>history.state?.id,g=async e=>{const t=E.transaction("entries","readwrite");await t.objectStore("entries").put(e),await t.commit()},N=async e=>{const t=E.transaction("entries","readwrite"),n=t.objectStore("entries");await n.clear();for(const r of e)await n.add(r);await t.commit()},D=async e=>N(e.map(t=>t.__getInit())),ut=async e=>{const t=E.transaction("entries","readwrite");await t.objectStore("entries").add(e),await t.commit()},dt=F(async()=>{sessionStorage.setItem(_,_);let t=(await at()).map(s=>new w(s));const n=await ct();let r=n&&t.find(s=>s.id===n);if(!r){const s={id:crypto.randomUUID(),index:0,key:crypto.randomUUID(),url:location.href,state:void 0,sessionKey:M};r=new w(s),t=[r],history.replaceState(s,"",s.url),await N([s])}return{entries:t,currentEntry:r}});class y extends EventTarget{#t;constructor(t){super(),this.#t=t}entries(){return this.#t.entries}get currentEntry(){return this.#t.currentEntry}updateCurrentEntry(t){const n=this.#t.currentEntry;history.replaceState({...n.__getInit(),state:t.state},"",location.href),n.__setState(history.state.state),g(history.state)}#n=null;get transition(){return this.#n}get canGoBack(){const{currentEntry:t}=this,n=this.entries();return!t||n.length===0?!1:t.index>n.at(0).index}get canGoForward(){const{currentEntry:t}=this,n=this.entries();return!t||n.length===0?!1:t.index<n.at(-1).index}navigate(t,n){const s=new URL(t,document.baseURI).href,i=I(n?.history).with("push","replace",P=>P).otherwise(()=>s===location.href?"replace":"push"),o=new m,a=this.#t.currentEntry,c=a.index,d={id:crypto.randomUUID(),index:I(i).with("push",()=>c+1).with("replace",()=>c).exhaustive(),key:crypto.randomUUID(),url:s,state:n?.state,sessionKey:M};return y.#e(this,o,a,d,i,n?.info),o.result}reload(t){const n="reload",r=new m,s=this.#t.currentEntry,i=t?.state===void 0?s:{...s.__getInit(),state:t?.state};return y.#e(this,r,s,i,n,t?.info),r.result}traverseTo(t,n){const r=this.#t.entries.find(i=>i.key===t),s=new m;if(!r)s.abort.abort(new DOMException("Invalid key","InvalidStateError"));else{const i="traverse",o=this.#t.currentEntry;y.#e(this,s,o,r,i,n?.info)}return s.result}back(t){const n="traverse",r=new m,s=this.#t.currentEntry,i=this.#t.entries,o=i[i.indexOf(s)-1];return o?y.#e(this,r,s,o,n,t?.info):r.abort.abort(new DOMException("Cannot go back","InvalidStateError")),r.result}forward(t){throw new Error("Method not implemented.")}static#e(t,n,r,s,i,o){let a,c;s instanceof w?(c=s,a=s.__getInit()):a=s;const d=new z({navigationType:i,canIntercept:!0,hashChange:new URL(a.url).hash!==new URL(r.url).hash,destination:new G(a),signal:n.abort.signal,formData:null,downloadRequest:null,info:o});if(t.dispatchEvent(d)){const h=c??new w(a);t.#t.currentEntry=h;const u=t.#t.entries;n.committer.resolve(h),I(i).with("push",()=>{history.pushState(a.state,"",a.url||location.href);const l=u.indexOf(r)+1;l===0?(u.length=0,u.push(h),D(u)):l===u.length?(u.push(h),ut(a)):(u.splice(l,u.length-l,h),D(u))}).with("replace",()=>{history.replaceState(a.state,"",a.url||location.href),g(a);const l=u.indexOf(r);l===-1?(u.length=0,u.push(h),D(u)):(u[l]=h,g(a))}).with("traverse",()=>{history.go(a.index-r.index),g(a)}).with("reload",async()=>{h.getState()!==r.getState()&&await g(a),location.reload()}).exhaustive(),t.dispatchEvent(new H({navigationType:i,from:r})),(async()=>{try{t.#n=new $({navigationType:i,from:r,finished:n.finisher.promise.then(()=>{})}),await d.__runHandler(),n.finisher.resolve(h)}catch(l){n.finisher.reject(l)}t.#n=null})()}else{const h=new DOMException("Navigation was aborted","AbortError");n.abort.abort(h)}}}class m{committer=j();finisher=j();abort=new AbortController;result={committed:this.committer.promise,finished:this.finisher.promise};constructor(){const t=this.abort;t.signal.addEventListener("abort",()=>{this.committer.reject(t.signal.reason),this.finisher.reject(t.signal.reason)})}}const ht=new y(await dt());globalThis.minNavigation=ht;export{z as MinNavigateEvent,y as MinNavigation,ht as navigation};
