import{z as I,f as q,_ as W,b as j}from"./css-color-mix-CkVeYiGO.js";import{e as z}from"./my-element-TnI_SUh3.js";const w={timeout:e=>t=>{const n=setTimeout(t,e);return()=>clearTimeout(n)},raf:e=>{const t=requestAnimationFrame(e);return()=>cancelAnimationFrame(t)},microtask:e=>{let t=!1;return queueMicrotask(()=>{t||e()}),()=>{t=!0}},eventTarget:(e,t)=>n=>(e.addEventListener(t,n),()=>e.removeEventListener(t,n)),from:e=>typeof e=="number"?e<=0?w.microtask:w.timeout(e):e},H=(e,t)=>{const n=Promise.withResolvers();let r=n.resolve,s=n.reject;const o=w.from(e)(r);return Object.assign(n.promise,{cancel(c){o(),s(c)}})};class Q extends Event{#t;constructor(t){if(super("navigate",t),!t)throw new TypeError("init required");if(!t.destination)throw new TypeError("destination required");if(!t.signal)throw new TypeError("signal required");this.#t={canIntercept:t.canIntercept??!1,destination:t.destination,downloadRequest:t.downloadRequest||null,formData:t.formData||null,hasUAVisualTransition:!1,hashChange:t.hashChange??!1,info:t.info,signal:t.signal,userInitiated:t.userInitiated??!1,navigationType:t.navigationType??"push"}}async __runHandler(){const t=this.#n;typeof t=="function"&&await t.call(this),this.#e,this.#r}get navigationType(){return this.#t.navigationType}get canIntercept(){return this.#t.canIntercept}get canTransition(){return this.#t.canIntercept}get userInitiated(){return this.#t.userInitiated}get hashChange(){return this.#t.hashChange}get hasUAVisualTransition(){return this.#t.hasUAVisualTransition}get destination(){return this.#t.destination}get signal(){return this.#t.signal}get formData(){return this.#t.formData}get downloadRequest(){return this.#t.downloadRequest}get info(){return this.#t.info}#n;#e;#r;intercept(t){t&&(this.#n=t.handler,this.#e=t.focusReset,this.#r=t.scroll)}scroll(){}}Promise.withResolvers||(Promise.withResolvers=function(){let e,t;return{promise:new this((r,s)=>{e=r,t=s}),resolve:e,reject:t}});const L=Promise.withResolvers.bind(Promise);class G extends Event{__init;constructor(t){super("currententrychange",t),this.__init=t}get navigationType(){return this.__init.navigationType??null}get from(){return this.__init.from}}class ${__init;get id(){return this.__init.id}get index(){return this.__init.index}get key(){return this.__init.key}get sameDocument(){return!0}get url(){return this.__init.url}getState(){return this.__init.state}constructor(t){this.__init=t}}let p=(()=>{let e=EventTarget,t,n=[],r=[];return class extends e{static{const i=typeof Symbol=="function"&&Symbol.metadata?Object.create(e[Symbol.metadata]??null):void 0;t=[z()],W(this,null,t,{kind:"accessor",name:"ondispose",static:!1,private:!1,access:{has:o=>"ondispose"in o,get:o=>o.ondispose,set:(o,a)=>{o.ondispose=a}},metadata:i},n,r),i&&Object.defineProperty(this,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:i})}__init;get id(){return this.__init.id}get index(){return this.__init.index}get key(){return this.__init.key}get sameDocument(){return!0}get url(){return this.__init.url}getState(){return this.__init.state}__getInit(){return this.__init}__setState(i){this.__init.state=i}#t=j(this,n,void 0);get ondispose(){return this.#t}set ondispose(i){this.#t=i}constructor(i){super(),j(this,r),this.__init=i}}})();class J{__init;constructor(t){this.__init=t}get navigationType(){return this.__init.navigationType}get from(){return this.__init.from}get finished(){return this.__init.finished}}const S=(e,t)=>t.some(n=>e instanceof n);let R,U;function X(){return R||(R=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Y(){return U||(U=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const T=new WeakMap,v=new WeakMap,E=new WeakMap;function Z(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{n(f(e.result)),s()},o=()=>{r(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",o)});return E.set(t,e),t}function tt(e){if(T.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{n(),s()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});T.set(e,t)}let M={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return T.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function V(e){M=e(M)}function et(e){return Y().includes(e)?function(...t){return e.apply(k(this),t),f(this.request)}:function(...t){return f(e.apply(k(this),t))}}function nt(e){return typeof e=="function"?et(e):(e instanceof IDBTransaction&&tt(e),S(e,X())?new Proxy(e,M):e)}function f(e){if(e instanceof IDBRequest)return Z(e);if(v.has(e))return v.get(e);const t=nt(e);return t!==e&&(v.set(e,t),E.set(t,e)),t}const k=e=>E.get(e);function rt(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(e,t),a=f(o);return r&&o.addEventListener("upgradeneeded",c=>{r(f(o.result),c.oldVersion,c.newVersion,f(o.transaction),c)}),n&&o.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}const st=["get","getKey","getAll","getAllKeys","count"],it=["put","add","delete","clear"],D=new Map;function A(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(D.get(t))return D.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=it.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||st.includes(n)))return;const i=async function(o,...a){const c=this.transaction(o,s?"readwrite":"readonly");let l=c.store;return r&&(l=l.index(a.shift())),(await Promise.all([l[n](...a),s&&c.done]))[0]};return D.set(t,i),i}V(e=>({...e,get:(t,n,r)=>A(t,n)||e.get(t,n,r),has:(t,n)=>!!A(t,n)||e.has(t,n)}));const ot=["continue","continuePrimaryKey","advance"],O={},B=new WeakMap,N=new WeakMap,at={get(e,t){if(!ot.includes(t))return e[t];let n=O[t];return n||(n=O[t]=function(...r){B.set(this,N.get(this)[t](...r))}),n}};async function*ct(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,at);for(N.set(n,t),E.set(n,k(t));t;)yield n,t=await(B.get(n)||t.continue()),B.delete(n)}function K(e,t){return t===Symbol.asyncIterator&&S(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&S(e,[IDBIndex,IDBObjectStore])}V(e=>({...e,get(t,n,r){return K(t,n)?ct:e.get(t,n,r)},has(t,n){return K(t,n)||e.has(t,n)}}));const b=await rt("appn-navigation",1,{upgrade(e){e.createObjectStore("entries",{keyPath:"key"}).createIndex("sessionKey","sessionKey")}}),_="--appn-navigation-reload--";if(sessionStorage.getItem(_)==_)for(console.log("QAQ start history.state",history.state);history.state?.sessionKey==null;){history.back();const e=await H(w.eventTarget(window,"popstate"));console.log("QAQ back history.state",history.state,e)}const C=history.state?.sessionKey??crypto.randomUUID(),ut=async()=>{const e=b.transaction("entries"),n=await e.objectStore("entries").index("sessionKey").getAll(C);return e.commit(),n.sort((r,s)=>r.index-s.index)},lt=()=>history.state?.id,m=async e=>{const t=b.transaction("entries","readwrite");await t.objectStore("entries").put(e),await t.commit()},F=async e=>{const t=b.transaction("entries","readwrite"),n=t.objectStore("entries");await n.clear();for(const r of e)await n.add(r);await t.commit()},x=async e=>F(e.map(t=>t.__getInit())),dt=async e=>{const t=b.transaction("entries","readwrite");await t.objectStore("entries").add(e),await t.commit()},ht=q(async()=>{sessionStorage.setItem(_,_);let t=(await ut()).map(s=>new p(s));const n=await lt();let r=n&&t.find(s=>s.id===n);if(!r){const s={id:crypto.randomUUID(),index:0,key:crypto.randomUUID(),url:location.href,state:void 0,sessionKey:C};r=new p(s),t=[r],history.replaceState(s,"",s.url),await F([s])}return{entries:t,currentEntry:r}});class y extends EventTarget{#t;constructor(t){super(),this.#t=t}entries(){return this.#t.entries}get currentEntry(){return this.#t.currentEntry}updateCurrentEntry(t){const n=this.#t.currentEntry;history.replaceState({...n.__getInit(),state:t.state},"",location.href),n.__setState(history.state.state),m(history.state)}#n=null;get transition(){return this.#n}get canGoBack(){const{currentEntry:t}=this,n=this.entries();return!t||n.length===0?!1:t.index>n.at(0).index}get canGoForward(){const{currentEntry:t}=this,n=this.entries();return!t||n.length===0?!1:t.index<n.at(-1).index}navigate(t,n){const s=new URL(t,document.baseURI).href,i=I(n?.history).with("push","replace",P=>P).otherwise(()=>s===location.href?"replace":"push"),o=new g,a=this.#t.currentEntry,c=a.index,l={id:crypto.randomUUID(),index:I(i).with("push",()=>c+1).with("replace",()=>c).exhaustive(),key:crypto.randomUUID(),url:s,state:n?.state,sessionKey:C};return y.#e(this,o,a,l,i,n?.info),o.result}reload(t){const n="reload",r=new g,s=this.#t.currentEntry,i=t?.state===void 0?s:{...s.__getInit(),state:t?.state};return y.#e(this,r,s,i,n,t?.info),r.result}traverseTo(t,n){const r=this.#t.entries.find(i=>i.key===t),s=new g;if(!r)s.abort.abort(new DOMException("Invalid key","InvalidStateError"));else{const i="traverse",o=this.#t.currentEntry;y.#e(this,s,o,r,i,n?.info)}return s.result}back(t){const n="traverse",r=new g,s=this.#t.currentEntry,i=this.#t.entries,o=i[i.indexOf(s)-1];return o?y.#e(this,r,s,o,n,t?.info):r.abort.abort(new DOMException("Cannot go back","InvalidStateError")),r.result}forward(t){throw new Error("Method not implemented.")}static#e(t,n,r,s,i,o){let a,c;s instanceof p?(c=s,a=s.__getInit()):a=s;const l=new Q({navigationType:i,canIntercept:!0,hashChange:new URL(a.url).hash!==new URL(r.url).hash,destination:new $(a),signal:n.abort.signal,formData:null,downloadRequest:null,info:o});if(t.dispatchEvent(l)){const d=c??new p(a);t.#t.currentEntry=d;const u=t.#t.entries;n.committer.resolve(d),I(i).with("push",()=>{history.pushState(a.state,"",a.url||location.href);const h=u.indexOf(r)+1;h===0?(u.length=0,u.push(d),x(u)):h===u.length?(u.push(d),dt(a)):(u.splice(h,u.length-h,d),x(u))}).with("replace",()=>{history.replaceState(a.state,"",a.url||location.href),m(a);const h=u.indexOf(r);h===-1?(u.length=0,u.push(d),x(u)):(u[h]=d,m(a))}).with("traverse",()=>{history.go(a.index-r.index),m(a)}).with("reload",async()=>{d.getState()!==r.getState()&&await m(a),location.reload()}).exhaustive(),t.dispatchEvent(new G({navigationType:i,from:r})),(async()=>{try{t.#n=new J({navigationType:i,from:r,finished:n.finisher.promise.then(()=>{})}),await l.__runHandler(),n.finisher.resolve(d)}catch(h){n.finisher.reject(h)}t.#n=null})()}else{const d=new DOMException("Navigation was aborted","AbortError");n.abort.abort(d)}}}class g{committer=L();finisher=L();abort=new AbortController;result={committed:this.committer.promise,finished:this.finisher.promise};constructor(){const t=this.abort;t.signal.addEventListener("abort",()=>{this.committer.reject(t.signal.reason),this.finisher.reject(t.signal.reason)})}}const ft=new y(await ht());globalThis.minNavigation=ft;export{Q as MinNavigateEvent,y as MinNavigation,ft as navigation};
